@page "/all-products"
@using jbH60Manager.Models
@inject HttpClient httpClient


<h3>All Products</h3>


    @if (products == null)
    {
        <p>Loading products...</p>
    }
    else if (products.Count == 0)
    {
        <p>No products found</p>
    }
    else
    {
        <SearchBar OnSearchRequested="HandleSearch"></SearchBar>
    <div class="row">
        @foreach (var item in products)
        {
            @if (item != null)
            {
                <div class="col-md-4 mb-3">
                    <div class="card ">
                        <div class="card-body @((item.Stock == 0) ? "bg-low-stock" : "")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title text-center">
                                    @item.Description
                                </h5>
                                <div class="d-inline-block">
                                    <a href="product/edit/updatestock/@item.ProductId" class="btn btn-sm btn-stock">Update Stock</a>
                                    <a href="product/edit/updateprices/@item.ProductId" class="btn btn-sm btn-price"> Update Prices
                                    </a>
                                </div>
                            </div>
                            <div class="card-text ">
                                @if (item.Stock == 0)
                                {
                                    <p class="text-danger">Please restock</p>
                                }
                                <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)" alt="Image of @item.Description" />
                                <div class="card-footer">
                                    <a href="product/@item.ProductId" class="btn">View Details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}


@code {
    private List<Product> products;
    private ProductCategory prodCat;
    protected override async Task OnInitializedAsync()
    {
        try
        {
            products = await httpClient.GetFromJsonAsync<List<Product>>("http://localhost:5076/api/Products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching products: {ex.Message}");
        }
    }
    private async Task HandleSearch(string searchQuery)
    {
     
        var parts = searchQuery.Split(':');
        var criteria = parts[0];
        var term = parts[1];


        if (criteria == "BuyPrice")
        {
            products = await httpClient.GetFromJsonAsync<List<Product>>($"http://localhost:5076/api/Products/SearchProductByBuyPrice/{term}");

        }else if (criteria == "SellPrice")
        {
            products = await httpClient.GetFromJsonAsync<List<Product>>($"http://localhost:5076/api/Products/SearchProductBySellPrice/{term}");

        }else if(criteria == "Description")
        {
            products = await httpClient.GetFromJsonAsync<List<Product>>($"http://localhost:5076/api/Products/ProductSearch/{term}");

        }else if(criteria == "Stock")
        {
            products = await httpClient.GetFromJsonAsync<List<Product>>($"http://localhost:5076/api/Products/SearchProductByStock/{term}");

        }
        else if (criteria == "ProductCategory")
        {
            prodCat = await httpClient.GetFromJsonAsync<ProductCategory>($"http://localhost:5076/api/ProductCategories/ProductCategorySearch/{term}");

        }

 
    }
   
}
